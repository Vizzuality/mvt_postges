<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapbox GL JS Examples</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>
var hoveredStateId = null;

//QUERY THE DATA:
// we will need to make this request to get the data - see the jupyter notebook
//var url = "http://0.0.0.0:5100/v1/query?sql=SELECT json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) AS geojson FROM (SELECT u.year, u.country, SUM(u.if_ghg_v), ST_Union(U.geom) geom FROM (SELECT if_ghg_v, country, year,geom FROM mgis_point_data UNION ALL SELECT  if_ghg_v, country, year,geom FROM mgis_poly_centroids) AS u GROUP BY u.country, u.year ORDER BY u.country ) AS t"
var maxValue = 4584.233695766365;
var meanValue = 264.7127784799982;
var data = [
    {'year': 2018, 'name_0': 'Argentina', 'sum': 347.43751563152045},
    {'year': 2018, 'name_0': 'Australia', 'sum': 492.4730577252386},
    {'year': 2018, 'name_0': 'Austria', 'sum': 243.1308210647556},
    {'year': 2018, 'name_0': 'Belarus', 'sum': 126.6921509007072},
    {'year': 2018, 'name_0': 'Belgium', 'sum': 320.6448200699031},
    {'year': 2018, 'name_0': 'Benin', 'sum': 9.6525464294907},
    {'year': 2018, 'name_0': 'Bosnia And Herzegovina', 'sum': 1.20350960758013},
    {'year': 2018, 'name_0': 'Brazil', 'sum': 2321.803752433495},
    {'year': 2018, 'name_0': 'Bulgaria', 'sum': 2.69823093072661},
    {'year': 2018, 'name_0': 'Burkina Faso', 'sum': 9.6525464294907},
    {'year': 2018, 'name_0': 'Cambodia', 'sum': 0.888230736617595},
    {'year': 2018, 'name_0': 'Cameroon', 'sum': 101.8929002470066},
    {'year': 2018, 'name_0': 'Canada', 'sum': 429.15453231257885},
    {'year': 2018, 'name_0': 'Chile', 'sum': 158.13814998038043},
    {'year': 2018, 'name_0': 'China', 'sum': 453.53785534428937},
    {'year': 2018, 'name_0': 'Colombia', 'sum': 24.85381799361834},
    {'year': 2018, 'name_0': 'Costa Rica', 'sum': 2.21129372723701},
    {'year': 2018, 'name_0': "Cote D'Ivoire", 'sum': 182.23010966390268},
    {'year': 2018, 'name_0': 'Croatia', 'sum': 16.18699101744084},
    {'year': 2018, 'name_0': 'Czech Republic', 'sum': 86.51297240779716},
    {'year': 2018, 'name_0': 'Denmark', 'sum': 230.88006217911328},
    {'year': 2018, 'name_0': 'Dominican Republic', 'sum': 19.0858920788464},
    {'year': 2018, 'name_0': 'Ecuador', 'sum': 163.08503137977493},
    {'year': 2018, 'name_0': 'Estonia', 'sum': 129.80193041429436},
    {'year': 2018, 'name_0': 'Fiji', 'sum': 0.774834386693613},
    {'year': 2018, 'name_0': 'Finland', 'sum': 124.6349065563775},
    {'year': 2018, 'name_0': 'France', 'sum': 564.5037639222332},
    {'year': 2018, 'name_0': 'Germany', 'sum': 1176.3204849992956},
    {'year': 2018, 'name_0': 'Ghana', 'sum': 131.63569397576208},
    {'year': 2018, 'name_0': 'Global/Unknown', 'sum': 143.2104445337536},
    {'year': 2018, 'name_0': 'Greece', 'sum': 0.101070073758932},
    {'year': 2018, 'name_0': 'Guatemala', 'sum': 2.21129372723701},
    {'year': 2018, 'name_0': 'Honduras', 'sum': 2.21129372723701},
    {'year': 2018, 'name_0': 'Hungary', 'sum': 375.4719309832097},
    {'year': 2018, 'name_0': 'Iceland', 'sum': 3.099337546774452},
    {'year': 2018, 'name_0': 'India', 'sum': 4584.233695766365},
    {'year': 2018, 'name_0': 'Indonesia', 'sum': 150.89786342271913},
    {'year': 2018, 'name_0': 'Ireland', 'sum': 75.41147379079794},
    {'year': 2018, 'name_0': 'Israel', 'sum': 19.6637483885004},
    {'year': 2018, 'name_0': 'Italy', 'sum': 127.07732758815519},
    {'year': 2018, 'name_0': 'Japan', 'sum': 40.65273994289956},
    {'year': 2018, 'name_0': 'Latvia', 'sum': 112.84073479469897},
    {'year': 2018, 'name_0': 'Lithuania', 'sum': 112.99054865466981},
    {'year': 2018, 'name_0': 'Luxembourg', 'sum': 25.74790387323686},
    {'year': 2018, 'name_0': 'Madagascar', 'sum': 10.2665764771769},
    {'year': 2018, 'name_0': 'Malaysia', 'sum': 17.62010797548317},
    {'year': 2018, 'name_0': 'Mali', 'sum': 9.6525464294907},
    {'year': 2018, 'name_0': 'Mauritania', 'sum': 0.968542983148867},
    {'year': 2018, 'name_0': 'Mexico', 'sum': 197.30930856449672},
    {'year': 2018, 'name_0': 'Moldova', 'sum': 0.61719733072661},
    {'year': 2018, 'name_0': 'Morocco', 'sum': 0.968542983148867},
    {'year': 2018, 'name_0': 'Netherlands', 'sum': 223.38792194161442},
    {'year': 2018, 'name_0': 'New Zealand', 'sum': 809.0214522232328},
    {'year': 2018, 'name_0': 'Nicaragua', 'sum': 1.10017608530457},
    {'year': 2018, 'name_0': 'Nigeria', 'sum': 114.9510205966452},
    {'year': 2018, 'name_0': 'Norway', 'sum': 128.78739563819576},
    {'year': 2018, 'name_0': 'Pakistan', 'sum': 4.113},
    {'year': 2018, 'name_0': 'Panama', 'sum': 1.11111764193244},
    {'year': 2018, 'name_0': 'Papua New Guinea', 'sum': 96.89380021920292},
    {'year': 2018, 'name_0': 'Peru', 'sum': 186.99882120195213},
    {'year': 2018, 'name_0': 'Philippines', 'sum': 5.149265730907132},
    {'year': 2018, 'name_0': 'Poland', 'sum': 1443.4535145161155},
    {'year': 2018, 'name_0': 'Portugal', 'sum': 39.95631139896597},
    {'year': 2018, 'name_0': 'Romania', 'sum': 3.28705599589791},
    {'year': 2018, 'name_0': 'Russian Federation', 'sum': 478.7439651410051},
    {'year': 2018, 'name_0': 'Serbia', 'sum': 5.30387037104392},
    {'year': 2018, 'name_0': 'Slovakia', 'sum': 175.17083336615886},
    {'year': 2018, 'name_0': 'Slovenia', 'sum': 22.61492749279384},
    {'year': 2018, 'name_0': 'South Africa', 'sum': 42.86126471196937},
    {'year': 2018, 'name_0': 'Spain', 'sum': 252.69761099430085},
    {'year': 2018, 'name_0': 'Sweden', 'sum': 85.31060762178967},
    {'year': 2018, 'name_0': 'Taiwan', 'sum': 3.202389054132196},
    {'year': 2018, 'name_0': 'Thailand', 'sum': 99.12320823563915},
    {'year': 2018, 'name_0': 'Togo', 'sum': 10.33483131454004},
    {'year': 2018, 'name_0': 'Turkey', 'sum': 1.59203576291061},
    {'year': 2018, 'name_0': 'Ukraine', 'sum': 23.88757754578732},
    {'year': 2018, 'name_0': 'United Kingdom', 'sum': 474.77352906371715},
    {'year': 2018,'name_0': 'United States of America','sum': 2453.3067597302966},
    {'year': 2018, 'name_0': 'Uruguay', 'sum': 81.13484929925318},
    {'year': 2018, 'name_0': 'Vietnam', 'sum': 23.81053140069419}
    ];

//console.log(data)


// filters for classifying earthquakes into five categories based on magnitude
var seg1 = ["any", false, ["==", ["get", "segment"], "Petcare"]]
var seg2 = ["any", false, ["==", ["get", "segment"], "Mars Wrigley"]]
var seg3 = ["any", false, ["==", ["get", "segment"], null]]
var colors = ['#1c9099', '#7bccc4','#ccc' ];//

var map = new mapboxgl.Map({
    'container': 'map',
    'zoom': 5,
    'center': [14.150390625,
          0.7031073524364909], // New York
    "light": {"intensity": 0.2},
    'style': {
        'version': 8,
        'sources': {
            'carto-dark': {
                'type': 'raster',
                'tiles': [
                    "http://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
                    "http://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
                    "http://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
                    "http://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"
                ]
            },
            'postgis-tiles': {
                'type': 'vector',
                //'minzoom':11,
                'maxzoom': 22,
                'tiles': [
                    "http://0.0.0.0:5100/v1/tiles/{z}/{x}/{y}.pbf?sql=select *, st_transform(geom, 3857) as the_geom_webmercator from mgis_point_data",
                    "http://0.0.0.0:5100/v1/tiles/{z}/{x}/{y}.pbf?sql=select *, st_transform(geom, 3857) as the_geom_webmercator from mgis_poly_centroids"
                ]
            },
            'postgis-geojson': {
                'type': 'geojson',
                'cluster': true,
                'clusterMaxZoom': 10, // Max zoom to cluster points on
                'clusterRadius': 50, // Radius of each cluster when clustering points (defaults to 50)
                // 'clusterProperties': {
                //     // keep separate counts for each magnitude category in a cluster
                //     'mag1': ['+', ['case', mag1, 1, 0]],
                //     'mag2': ['+', ['case', mag2, 1, 0]],
                //     'mag3': ['+', ['case', mag3, 1, 0]],
                //     },
                'data': "http://0.0.0.0:5100/v1/query?sql=select json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) as geojson from (select geom, id, commodity from mgis_poly_centroids union all select geom, id, commodity from mgis_point_data) as t"
                
            },
            'MARS_BASEMAP': {//customised basemap
                'type': 'raster',
                'tiles': [
                    "https://api.mapbox.com/styles/v1/mars-mgis/ck98arhfo0le81iluoamfv1jd/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFycy1tZ2lzIiwiYSI6ImNrMjV5dGVmcjFrdjUzZ25yeTk2ZDdoenEifQ.xXWMgAh8cRAu6HAjt5cjtA",
                ]
            },

        },
        "sprite": "https://openmaptiles.github.io/klokantech-basic-gl-style/sprite",
        'glyphs': "https://orangemug.github.io/font-glyphs/glyphs/{fontstack}/{range}.pbf",
        'layers': [{
            'id': 'mapbox_monochrome-layer',
            'type': 'raster',
            'source': 'MARS_BASEMAP',
            'minzoom': 0,
            'maxzoom': 22
        },
        // {
        //     'id': 'postgis-tiles-layer',
        //     'type': 'fill',
        //     'source': 'postgis-tiles',
        //     // ST_AsMVT() uses 'layer0' as layer name
        //     'source-layer': 'layer0', 
        //     'minzoom': 0,
        //     'maxzoom': 22,
        //     'paint': {
        //         'fill-opacity': [
        //                         'case',
        //                         ['boolean', ['feature-state', 'hover'], false],
        //                         1,
        //                         0.5
        //                         ],
        //         'fill-color': 'red'
        //     }
        // },
        // {
        // 'id': 'unclustered-point',
        // 'type': 'circle',
        // 'source': 'postgis-tiles',
        // 'source-layer': 'layer0',
        // 'minzoom': 10,
        //     'maxzoom': 22,
        // 'paint': {
        // 'circle-color': '#11b4da',
        // 'circle-radius': 10,
        // 'circle-stroke-width': 0,
        // 'circle-opacity': 0.3
        //     }
        // }
        ]
    }
});


map.addControl(new mapboxgl.NavigationControl());
map.on('load', function() {
    map.addSource(
        'postgis-geojson_2', {//geojson jus has the commodity and segment - we need to add the other attributes - simple clustering
            type: 'geojson',
            data: "http://0.0.0.0:5100/v1/query?sql=select json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) as geojson from (select geom, id, commodity,segment from mgis_poly_centroids union all select geom, id, commodity, segment from mgis_point_data) as t",//"http://0.0.0.0:5100/v1/query?sql=select json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) as geojson from mgis_point_data as t&format=geojson",
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 30,
            },
            );

    map.addSource(
        'postgis-geojson_3', { //geojson jus has the commodity and segment - we need to add the other attributes - donut clustering
            type: 'geojson',
            data: "http://0.0.0.0:5100/v1/query?sql=select json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) as geojson from (select geom, id, commodity, year, segment, country_is, country, region, fraction, subsegment, t1_supplie, volume, total_ghg, if_ghg_v, land, if_land_v, withdrawal, if_wdl_v, if_h2o_v, bws, origin_sup from mgis_poly_centroids union all select geom, id, commodity, year, segment, country_is, country, region, fraction, subsegment, t1_supplie, volume, total_ghg, if_ghg_v, land, if_land_v, withdrawal, if_wdl_v, if_h2o_v, bws, origin_sup from mgis_point_data) as t",
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 30,
            clusterProperties: {
            'seg1': ['+', ['case', seg1, 1, 0]],
            'seg2': ['+', ['case', seg2, 1, 0]],
            'seg3': ['+' ,['case', seg3, 1, 0]]
                }               
            },
            );
    map.addSource( // Adds source for the gdam data
        'gdam_vector', { 
            'type': 'vector',
            'maxzoom': 22,
            'tiles': ["http://0.0.0.0:5100/v1/tiles/{z}/{x}/{y}.pbf?sql=select *, st_transform(geom, 3857) as the_geom_webmercator from gadm36_0_simp where gid_0 NOT LIKE 'ATA'"],
            //'tiles':["http://0.0.0.0:5100/v1/tiles/{z}/{x}/{y}.pbf?sql=SSELECT json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) AS geojson FROM (SELECT * FROM (SELECT u.year, u.country, SUM(u.if_ghg_v), ST_Union(U.geom) geom FROM (SELECT if_ghg_v, country, year,geom FROM mgis_point_data  UNION ALL SELECT  if_ghg_v, country, year,geom FROM mgis_poly_centroids) AS u GROUP BY u.country, u.year ORDER BY u.country ) AS m LEFT JOIN (SELECT *, st_transform(geom, 3857) as the_geom_webmercator FROM gadm36_0_simp WHERE gid_0 NOT LIKE 'ATA') AS x ON m.country = x.NAME_0) AS t"]
            },
            );
    // map.addSource(
    //     'impact_json', { //geojson jus has the commodity and segment - we need to add the other attributes - donut clustering
    //         'type': 'geojson',
    //         'data': "http://0.0.0.0:5100/v1/query?sql=select json_build_object('type', 'FeatureCollection', 'features', json_agg(ST_AsGeoJSON(t.*)::json)) AS geojson FROM (SELECT u.year, u.country, SUM(u.if_ghg_v), ST_Union(U.geom) geom FROM (SELECT if_ghg_v, country, year,geom FROM mgis_point_data UNION ALL SELECT  if_ghg_v, country, year,geom FROM mgis_poly_centroids) AS u GROUP BY u.country, u.year ORDER BY u.country ) AS t",
    //         },
    //         );
    var expression = ['match', ['get', 'name_0']];

    // Calculate color for each state based on the unemployment rate
    data.forEach(function(row) {
    var green = (row['sum'] / meanValue) * 255;
    var color = 'rgba(' + 0 + ', ' + green + ', ' + 0 + ', 1)';
    expression.push(row['name_0'], color);
    });

    // Last value is the default, used where there is no data
    expression.push('rgba(204,204,204,1)');
    
    // Add layer from the vector tile source with data-driven style
    map.addLayer(
    {
    'id': 'choropleth',
    'type': 'fill',
    'source': 'gdam_vector',
    'source-layer': 'layer0',
    'paint': {
    'fill-color': expression,
    'fill-outline-color':'#f7f7f7'
    }
    }
    );
    console.log('DATA', data)

    // map.addLayer({
    // 'id': 'choropleth',
    // 'type': 'fill',
    // 'source': 'gdam_vector',
    // "source-layer":"layer0",
    // 'paint': {
    //     'fill-color':'#ccc',
    //     'fill-outline-color':'#f7f7f7'
    // }
    // });

    // map.addLayer({
    // 'id': 'choropleth_impacts',
    // 'type': 'circle',
    // 'source': 'impact_json',
    // //"source-layer":"layer0",
    // 'paint': {
    // }
    // });

    // --------------------CONFIG FOR SIMPLE CLUSTERING -----------------------////
    
    // map.addLayer({
    //         id: 'clusters',
    //         type: 'circle',
    //         source: 'postgis-geojson_2',
    //         filter: ['has', 'point_count'],
    //         paint: {
    //         'circle-color': [
    //         'step',
    //         ['get', 'point_count'],
    //         '#51bbd6',
    //         100,
    //         '#f1f075',
    //         750,
    //         '#f28cb1'
    //         ],
    //         'circle-radius': [
    //         'step',
    //         ['get', 'point_count'],
    //         20,
    //         100,
    //         30,
    //         750,
    //         40
    //         ]
    //         }
    //         });
 
    // map.addLayer({
    //         id: 'cluster-count',
    //         type: 'symbol',
    //         'source': 'postgis-geojson_2',
            
    //         filter: ['has', 'point_count'],
    //         layout: {
    //         'text-field': '{point_count_abbreviated}',
    //         'text-font': ['Roboto Black'],
    //         'text-size': 12
    //         }
    //         });

    // map.addLayer({
    //         id: 'unclustered-point',
    //         type: 'circle',
    //         source: 'postgis-geojson_2',
    //         filter: ['!', ['has', 'point_count']],
    //         paint: {
    //         'circle-color': '#11b4da',
    //         'circle-radius': 4,
    //         'circle-stroke-width': 1,
    //         'circle-stroke-color': '#fff'
    //         }
    //         });

    // --------------------CONFIG FOR DONUT CLUSTERING -----------------------////

//     map.addLayer({
//             'id': 'segment_circle_2',
//             'type': 'circle',
//             'source': 'postgis-geojson_3',
//             'filter': ['!=', 'cluster', true],
//             'paint': {
//             'circle-color': [
//             'case',
//             seg1,
//             colors[0],
//             seg2,
//             colors[1],
//             colors[2]
//             ],
//             'circle-opacity': 0.6,
//             'circle-radius': 5
//             }
//             });

//     map.addLayer({
//         'id': 'cluster_label_2',
//         'type': 'symbol',
//         'source': 'postgis-geojson_3',
//         filter: ['has', 'point_count'],
//         layout: {
//         'text-field': '{point_count_abbreviated}',
//         'text-font': ['Roboto Black'],
//         'text-size': 12
//             },
//         'paint': {
//         'text-color': [
//         'case',
//         ['<', ['get', 'segment'], 2],
//         'black',
//         'white'
//         ]
//         }
//         });

//     // objects for caching and keeping track of HTML marker objects (for performance)
//     var markers = {};
//     var markersOnScreen = {};
    
//     function updateMarkers() {
//         var newMarkers = {};
//         var features = map.querySourceFeatures('postgis-geojson_3');
        
//         // for every cluster on the screen, create an HTML marker for it (if we didn't yet),
//         // and add it to the map if it's not there already
//         for (var i = 0; i < features.length; i++) {
//         var coords = features[i].geometry.coordinates;
//         var props = features[i].properties;
//         if (!props.cluster) continue;
//         var id = props.cluster_id;
        
//         var marker = markers[id];
//         if (!marker) {
//         var el = createDonutChart(props);
//         marker = markers[id] = new mapboxgl.Marker({
//         element: el
//         }).setLngLat(coords);
//         }
//         newMarkers[id] = marker;
        
//         if (!markersOnScreen[id]) marker.addTo(map);
//         }
//         // for every marker we've added previously, remove those that are no longer visible
//         for (id in markersOnScreen) {
//         if (!newMarkers[id]) markersOnScreen[id].remove();
//         }
//         markersOnScreen = newMarkers;
// }

//     // after the GeoJSON data is loaded, update markers on the screen and do so on every map move/moveend
// map.on('data', function(e) {
// if (e.sourceId !== 'postgis-geojson_3' || !e.isSourceLoaded) return;
 
// map.on('move', updateMarkers);
// map.on('moveend', updateMarkers);
// updateMarkers();
// });
// });

// // code for creating an SVG donut chart from feature properties
// function createDonutChart(props) {
//         var offsets = [];
//         var counts = [
//             props.seg1,
//             props.seg2,
//             props.seg3,
//         ];
//         var total = 0;
//         for (var i = 0; i < counts.length; i++) {
//             offsets.push(total);
//             total += counts[i];
//         }
//         var fontSize =
//             total >= 1000 ? 22 : total >= 100 ? 20 : total >= 10 ? 18 : 16;
//         var r = total >= 1000 ? 50 : total >= 100 ? 32 : total >= 10 ? 24 : 18;
//         var r0 = Math.round(r * 0.6);
//         var w = r * 2;

//         var html =
//             '<div><svg width="' +
//             w +
//             '" height="' +
//             w +
//             '" viewbox="0 0 ' +
//             w +
//             ' ' +
//             w +
//             '" text-anchor="middle" style="font: ' +
//             fontSize +
//             'px sans-serif">';

//         for (i = 0; i < counts.length; i++) {
//             html += donutSegment(
//                 offsets[i] / total,
//                 (offsets[i] + counts[i]) / total,
//                 r,
//                 r0,
//                 colors[i]
//             );
//         }
//         html +=
//             '<circle cx="' +
//             r +
//             '" cy="' +
//             r +
//             '" r="' +
//             r0 +
//             '" fill="white" /><text dominant-baseline="central" transform="translate(' +
//             r +
//             ', ' +
//             r +
//             ')">' +
//             total.toLocaleString() +
//             '</text></svg></div>';

//         var el = document.createElement('div');
//         el.innerHTML = html;
//         return el.firstChild;
//     }

//     function donutSegment(start, end, r, r0, color) {
//         if (end - start === 1) end -= 0.00001;
//         var a0 = 2 * Math.PI * (start - 0.25);
//         var a1 = 2 * Math.PI * (end - 0.25);
//         var x0 = Math.cos(a0),
//             y0 = Math.sin(a0);
//         var x1 = Math.cos(a1),
//             y1 = Math.sin(a1);
//         var largeArc = end - start > 0.5 ? 1 : 0;

//         return [
//             '<path d="M',
//             r + r0 * x0,
//             r + r0 * y0,
//             'L',
//             r + r * x0,
//             r + r * y0,
//             'A',
//             r,
//             r,
//             0,
//             largeArc,
//             1,
//             r + r * x1,
//             r + r * y1,
//             'L',
//             r + r0 * x1,
//             r + r0 * y1,
//             'A',
//             r0,
//             r0,
//             0,
//             largeArc,
//             0,
//             r + r0 * x0,
//             r + r0 * y0,
//             '" fill="' + color + '" />'
//         ].join(' ');
//     }

//------------END DONUT CHART---------------------------------------------------

    map.on('mousemove', 'postgis-tiles-layer', function(e) {
        if (e.features.length > 0) {
            console.info(e.features[0])
            console.info(hoveredStateId)
            if (hoveredStateId) {
            map.setFeatureState(
                { source: 'postgis-tiles', sourceLayer: 'layer0',  id: hoveredStateId },
                { hover: false }
            );
            }
            hoveredStateId = e.features[0].id;
            map.setFeatureState(
                { source: 'postgis-tiles', sourceLayer: 'layer0',  id: hoveredStateId },
                { hover: true }
            );
        }
    });
    
    // When the mouse leaves the state-fill layer, update the feature state of the
    // previously hovered feature.
    map.on('mouseleave', 'postgis-tiles-layer', function() {
    if (hoveredStateId) {
    map.setFeatureState(
    { source: 'postgis-tiles', sourceLayer: 'layer0',  id: hoveredStateId },
    { hover: false }
    );
    }
    hoveredStateId = null;
    });
    // inspect a cluster on click
map.on('click', 'clusters', function(e) {
var features = map.queryRenderedFeatures(e.point, {
layers: ['clusters']
});
var clusterId = features[0].properties.cluster_id;
map.getSource('postgis-geojson').getClusterExpansionZoom(
clusterId,
function(err, zoom) {
    if (err) return;
 
        map.easeTo({
        center: features[0].geometry.coordinates,
        zoom: zoom
        });
    });
});

map.on('click', 'unclustered-point', function(e) {
 
var coordinates = e.features[0].geometry.coordinates.slice();
var mag = e.features[0].properties.segment;
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}
 
new mapboxgl.Popup()
.setLngLat(coordinates)
.setHTML("magnitude: " + mag)
.addTo(map);
});
 
map.on('mouseenter', 'clusters', function() {
map.getCanvas().style.cursor = 'pointer';
});
map.on('mouseleave', 'clusters', function() {
map.getCanvas().style.cursor = '';
});
});


</script>

 
</body>
</html>
